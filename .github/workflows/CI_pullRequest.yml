name: Auto pull request from develop to main

on:
  push:
    branches: [ develop ]

permissions:
  contents: write
  pull-requests: write

jobs:
  create-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Ensure no existing open PR (develop -> main)
        id: pr_check
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pulls } = await github.rest.pulls.list({ owner: context.repo.owner, repo: context.repo.repo, state: 'open', base: 'main', head: `${context.repo.owner}:develop` });
            if (pulls.length > 0) {
              core.setOutput('skip', 'true');
              core.notice(`PR ya existe (#${pulls[0].number}). No se creará otro.`);
            } else {
              core.setOutput('skip', 'false');
            }

      - name: Extract commit title
        id: commit_meta
        run: |
          RAW_MSG="${{ github.event.head_commit.message }}"
          FIRST_LINE=$(echo "$RAW_MSG" | head -n1 | tr -d '\r')
          # Limitar a 120 chars por seguridad
          TITLE_TRUNC=$(echo "$FIRST_LINE" | cut -c1-120)
          echo "title=$TITLE_TRUNC" >> $GITHUB_OUTPUT
          echo "Commit title usado para PR: $TITLE_TRUNC"

      - name: Create pull request
        if: steps.pr_check.outputs.skip == 'false'
        uses: repo-sync/pull-request@v2
        with:
          source_branch: develop
          destination_branch: main
          pr_title: ${{ steps.commit_meta.outputs.title }}
          pr_body: |
            Pull request automático generado por push a `develop`.
            Título = primera línea del último commit.
            Último commit completo:
            ${{ github.event.head_commit.message }}
          pr_label: auto-pr
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Output result
        run: |
          if [ "${{ steps.pr_check.outputs.skip }}" = "true" ]; then echo "PR existente. Nada que hacer."; else echo "PR creado o actualizado."; fi
  